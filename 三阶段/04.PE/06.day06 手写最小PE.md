## 本节内容

### 实现目标

-   实现目标：手写实现不大于 200 Byte大小的PE文件（又名：畸形PE/变形PE），要求MessageBox弹框显示一个字符串。
-   实现要点：充分利用空间，在保证遵循PE结构的基础上对数据结构进行重构存放。

### 环境工具

-   运行环境--XP系统：XP对于畸形PE的兼容性更高。参数检查相对win7和win10更宽松
-   编辑器--winhex：用于编写PE文件。

### 步骤

#### 1.创建文件

-   使用winhex工具，新建200字节大小的文件![img](notesimg/1636463632302-7e52e850-1c28-4ea7-bd7e-9804d4f9fa91.png)

myWinPE.exe文件创建流程

#### 2.编写DOS_HEADER部分  (大小为 0x 40 )

-   **文件偏移+0x00（注1），****WORD e_magic→'MZ'文件头标识：**0x5A4D**（注2）**
-   **文件偏移+0x3C，****LONG e_lfanew→指向****NT头****'PE'标识的地址：**0x00000040

-   -   此处设置NT头地址为0x4偏移的原因：1.充分利用每字节可用空间，DOS除首尾两字段外都非必要字段，可用；2.当NT头置于0x4处，0x3C的功能不仅是指向NT头标识，还将成为选项头的成员SectionAlignment（文件对齐值），在XP中，此项最小值为4。综上两点，此处写入0x4最为合适。

-   ![img](notesimg/1636466559188-5e7e98c7-b0fc-4e53-9071-db460d3d55a3.png)

 DOS_HEADER部分内容

#### 3.编写NT头的Signature部分

  Dos头中间有 大量 无用数据,可以把  NT 头数据拷到 dos 头 偏移位4的位置,然后修改 dos头 指向 NT头的偏移但是全部拷贝放不下,因此只能拷贝一部分,到导入表结束(因为后面的数据表没用)

-   **文件偏移+0x04，**DWORD Signature→**'PE00'**NT头标识**：0x00004550**
-   ![img](notesimg/1636466616847-b3874b5d-41e9-465b-bffb-c5b6e6c35bc6.png)



#### 4.编写NT头的FILE_HEADER部分

-   **文件偏移+0x08，**WORD Machine→指定程序的运行平台**：0x104C（运行于**Intel 386**）**
-   **文件偏移+0x10，**WORD NumberOfSections→PE中的节数量**：0x0001（最小限值）**
-   **文件偏移+0x18，**WORD SizeOfOptionalHeader→选项头大小**：0x0080**

-   -   选项头大小默认为0xE0，不过以目标为导向，我们还是要力求最小，计算可得，不包含数据目录字段的选项头结构体大小是0x60，而每一个数据目录数组元素的大小是0x8，此处我们留出4个数据目录元素的大小，即4*8=0x20，加上0x60=0x80。

-   **文件偏移+0x1A，**WORD Characteristics→文件属性：0x010F

-   -   0x010F组合属性表示：只在32位平台上运行的不存在行信息、重定位信息、符号信息的可执行文件。

-   ![img](notesimg/1636468177623-c8556e45-3711-499c-b645-91648400163c.png)

NT头的FILE_HEADER部分内容

#### 5.编写NT头的OPTIONAL_HEADER部分

-   **文件偏移+0x1C，**WORD Magic→PE标志字即程序位数**：0x010B（32位系统）**
-   **文件偏移+0x28，D**WORD AddressOfEntryPoint→程序执行入口RVA**：0x00000000**
-   **文件偏移+0x38，**DWORD ImageBase→内存加载基址**：0x00400000（exe默认）**
-   **文件偏移+0x40，**DWORD FileAlignment→文件对齐值**：0x00000004（最小限值）**
-   **文件偏移+0x4C，**WORD  MajorSubsystemVersion→主子系统版本号：**0x0004（恢复默认不可修改）**
-   **文件偏移+0x4E，**WORD  MinorSubsystemVersion→副子系统版本号：**0x0000（恢复默认不可修改）**
-   **文件偏移+0x50，**DWORD  Win32VersionValue→版本号，XP中须为0：**0x00000000**
-   **文件偏移+0x54，**DWORD SizeOfImage→PE文件在进程内存中的总大小：**0x00001000（内存预计占用1页内）**
-   **文件偏移+0x58，**DWORD SizeOfHeaders→PE文件头部在文件中的总大小：**0x000000C4（=文件实现目标大小）**
-   **文件偏移+0x60，**WORD  Subsystem→程序类型：**0x0002（**2=图形界面**）**
-   **文件偏移+0x62，**WORD   DllCharacteristics→文件特性：**0x0000（**默认为0**）**
-   **文件偏移+0x64，**DWORD  SizeOfStackReserve→初始化时保留的栈大小：**0x07FFFFFF**
-   **文件偏移+0x68，**DWORD  SizeOfStackCommit→初始化时实际提交的栈大小：**0x07FFFFFF**
-   **文件偏移+0x6C，**DWORD  SizeOfHeapReserve→初始化时保留的堆大小：**0x07FFFFFF**
-   **文件偏移+0x70，**DWORD  SizeOfHeapCommit→初始化时实际提交的堆大小：**0x07FFFFFF**
-   **文件偏移+0x78，**DWORD  NumberOfRvaAndSizes→数据目录的元素个数：**0x00000004**
-   **文件偏移+0x7C，**DataDirectory[4]→4项元素的数据目录：**全0**
-   ![img](notesimg/1636515670804-d881dbef-de13-47bf-ab3b-aaa2b6d61647.png)

NT头的OPTIONAL_HEADER部分内容

#### 6.编写节表部分

-   **文件偏移+0xA4，**DWORD VirtualSize→内存时机占用大小**：0x000000C4**
-   **文件偏移+0xA8，**DWORD VirtualAddress→内存地址RVA**：0x00000000**
-   **文件偏移+0xAC，**DWORD SizeOfRawData→文件大小**：0x000000C4**
-   **文件偏移+0xB0，**DWORD PointerToRawData→文件偏移**：0x00000000**
-    **文件偏移+0xC4，**DWORD Characteristics→节属性**：0x**E00000E0

-   -   **0x**E00000E0 = 1110 0000 0000 0000 0000 0000 1110 0000，根据图3-5显示，此属性值表示节中包含代码、已初始化数据和未初始化数据，且映射到内存后的页面可执行可读写。

-   ***0xA4-0xB3含义：**从文件偏移为0x0的位置，拷贝0xC4大小的数据到内存偏移为0x0的位置，占用内存0xC4大小
-   ![img](notesimg/1636499693716-d17d4fdd-a0e7-42a1-b9d7-d198c760c0c7.png)

节表部分内容

#### 7.基础PE总览（xdm先备份一下，再做后方花里胡哨的操作）

-   ![img](notesimg/1636515700189-82eb61dd-7d51-4930-9a75-948af1bc93fa.png)

 基础PE内容总览

#### 8.编写导入内容：库+函数

-   根据导入内容思考设计：实现弹框需要写入两项内容：1.库名（user32）；2.函数名（MessageBoxA）。根据两个字符串的长度（+00结束符）找到最合适的位置并写入：

-   -   **文件偏移+0x30， dll名**：**"user32 "，7Byte**
    -   **文件偏移+0x0C， 函数名**：**"**MessageBoxA **"，12Byte**
    -   ![img](notesimg/1636511315718-ede25752-7d0c-495e-becd-1464c32dfd43.png)

写入库名和函数名

#### 9.编写导入表项 

-   导入表IMAGE_IMPORT_DESCRIPTOR 置于**0xB0处**，因为PE加载后，0xB0-0xC3处内存会被初始化为全0。
-   **文件偏移+0xBC**：DWORD   Name→RVA指向dll名：**0x00000030**
-   **文件偏移+0xC0**：DWORD   FirstThunk→RVA指向IAT表：**0x0000009C**
-   ![img](notesimg/1636509802391-63e0ff7b-5c41-4eb7-84f0-7f304027f133.png)

#### 10.编写IAT表 IMAGE_THUNK_DATA32

-   **文件偏移+0x9C**，PIMAGE_IMPORT_BY_NAME  AddressOfData→指向IMAGE_IMPORT_BY_NAME：**0x0000000A**

-   -   **因为**IMAGE_IMPORT_BY_NAME结构体的指向函数名的NAME成员前还有一个WORD Hint成员，所以指向的地址需要跳过一个WORD 2字节，以实现NAME指向函数名。

-   **文件偏移+0xA0**，以全0作结尾项：**0x00000000**
-   ![img](notesimg/1636510839097-93c39b30-ef58-48ee-9918-65713e169184.png)

#### 11.将导入表位置写入数据目录中

-   **文件偏移+0x80**，DataDirectory[1]导入表位置：0x000000B0
-   ![img](notesimg/1636511414979-711f251d-e9ff-43ab-be27-784e47e4da19.png)
-   OD检测：内存窗口中跟随地址0x40009C，以"长型→地址"方式查看，可见导入成功。
-   ![img](notesimg/1636512081659-c7034c4d-a7aa-4ed2-8f01-25a9d28bbc69.png)

#### 12.编写汇编指令：获取MessageBoxA函数地址并传参调用

-   **文件偏移+0x60**，在选项头的堆栈空间值区编写弹框文本："hello world"
-   ![img](notesimg/1636512561551-2d6d2b01-4de4-4b1a-b2e4-7e772bcfdb34.png)
-   *选线头主版本号不可用，故以副链接器版本号成员处（0x1F）开始非重要区域编写指令：
-   **文件偏移+0x1F**，参数4 UINT uType→对话框按钮类型：6A 00 = push 0（注3）
-   **文件偏移+0x21**，参数3 LPCTSTR lpCaption→消息框标题：6A 00 = push 0
-   **文件偏移+0x23**，参数2 LPCTSTR lpText→消息框内容，指向"hello world"：68 64004000 = push 00400064
-   **文件偏移+0x25**，参数1 HWND hWnd→窗口句柄：6A 00 = push 0
-   **文件偏移+0x2A**，短跳至空闲区以备调用函数：EB18= jmp short 00400044
-   **文件偏移+0x44**，从IAT表中获取API地址并调用：FF15 9C004000= CALL  0040009C
-   **文件偏移+0x4A**，调用后返回：C3=ret
-   ![img](notesimg/1636515962629-f8583776-a696-4b63-941e-d510eda2fc2f.png)

#### 14.修改OEP

-   **文件偏移+0x44**，OEP：FF15 9C004000= CALL  0040009C
-   ![img](notesimg/1636514332938-a74cdd4d-cdda-4eda-a813-c6ed9785050b.png)

#### 15.完整PE总览

-   ![img](notesimg/1636516087915-36a8c717-14e0-4f73-8b09-60c6622d748c.png)

#### 



### 操作

-   ![img](notesimg/1655907165657-4c048f47-e645-4ae4-8d9a-6c05d3a460ec.png)

![img](notesimg/1655907604128-9fde19fa-1ece-47da-a367-a4d0b818b75e.png)

![img](notesimg/1655908469936-f788b641-4c74-4a16-be68-1994fe1eeaee.png)

修改导入表,导入表占 20字节 但前面 12个字节都没用

![img](notesimg/1655909432688-29537976-80e5-414e-910f-90cbf0fc3008.png)

上述操作之后的代码

![img](notesimg/1655909559405-2fe5c7d7-29b9-47f8-bf71-4256b34d6b64.png)

点击运行发现报错,说明我们的代码有问题

![img](notesimg/1655909524275-ec2e70db-33d4-4f83-a36e-d0fad7d5a8bf.png)

用OD 查看,发现导入函数并没有加载进来,说明我们的导入表构件的有问题

![img](notesimg/1655909875971-e9a17394-2ac8-44fe-9fd3-e79e0830e309.png)

初步检查发现如下错误

![img](notesimg/1655910483436-cc0630f4-5bc2-425b-8ee2-3e3026f25b9f.png)

继续寻找错误并把没用的数据用CC填充

![img](notesimg/1655910990214-061ef0c3-0fe7-4632-95bf-66ff68a04886.png)

![img](notesimg/1655910895641-ec776f0a-2ded-467b-8714-58d24e40a92b.png)

还是有错误,继续寻找

![img](notesimg/1655911466422-505f29d6-beba-4c87-b8ea-e0fffa8d8531.png)

![img](notesimg/1655911487381-fc7db3c8-748c-451f-b015-a41a4bcb387f.png)

继续找错误

![img](notesimg/1655912467312-518bd7e9-7f87-4430-bcf5-86b7d9b89b91.png)

再到OD去看,可以看到函数已经加载进来了

![img](notesimg/1655912849910-cefb86ab-5817-4719-b1f3-4da8dcedf6bc.png)

![img](notesimg/1655912958244-2d231faf-64f8-4aaf-99bb-d220db145281.png)

说明我们格式已经对了,接下来就是写代码了

函数入口点,之所以跳到 64,因此哪里空间多一点,可以写代码

![img](notesimg/1655914669561-d3379d8f-3572-4b32-9f3a-ef4b2cbcdff7.png)

![img](notesimg/1655913974408-e20ec5e9-4878-42aa-ac46-f948b847339e.png)

![img](notesimg/1655914003723-7f99c949-9936-4881-a210-13b1704f4c5b.png)

![img](notesimg/1655914500794-6f5c62cc-e917-45f4-ab71-5bd368a571ed.png)

运行发现只有标题没有内容,怀疑可能是栈被破坏了

![img](notesimg/1655914688816-21693f33-2610-4d60-bec8-951c5c79403c.png)

有一个标志  Win32VersionValue ,xp必须为0,win7 和win10不用管

![img](notesimg/1655916811672-5c9f29a9-84d9-4d27-8332-6ea94859f082.png)

点击发现功能实现了

![img](notesimg/1655916828438-7551b5ab-7b43-40d2-a105-9f6e1498e131.png)

![img](notesimg/1655917032129-0dd9703e-e9a6-49aa-9820-ed61c602091b.png)

```
Offset      0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F

00000000   4D 5A CC CC 50 45 00 00  4C 01 01 00 75 73 65 72   MZ烫PE  L   user
00000010   33 32 2E 64 6C 6C 00 CC  80 00 0F 01 0B 01 4D 65   32.dll 虁     Me
00000020   73 73 61 67 65 42 6F 78  41 00 CC CC 30 00 00 00   ssageBoxA 烫0   
00000030   6A 00 EB 30 CC CC CC CC  00 00 40 00 04 00 00 00   j ?烫烫  @     
00000040   04 00 00 00 CC CC CC CC  CC CC CC CC 04 00 CC CC       烫烫烫烫  烫
00000050   00 00 00 00 00 10 00 00  C4 00 00 00 CC CC CC CC           ?  烫烫
00000060   02 00 00 00 68 0C 00 40  00 68 1E 00 40 00 6A 00       h  @ h  @ j 
00000070   FF 15 B8 00 40 00 C3 CC  04 00 00 00 00 00 00 00    ?@ 锰        
00000080   00 00 00 00 90 00 00 00  CC CC CC CC 00 00 00 00       ?  烫烫    
00000090   00 00 00 00 00 00 00 00  00 00 00 00 0C 00 00 00                   
000000A0   B8 00 00 00 C4 00 00 00  00 00 00 00 C4 00 00 00   ?  ?      ?  
000000B0   00 00 00 00 00 00 00 00  1C 00 00 00 00 00 00 00                   
000000C0   40 00 00 C0                                        @  
```

还可以继续减少大小

因为系统准备内存会在里面填充0 , 因为后面的0可以全部删除 ,又因为 第一个节就算不给属性系统也会自动给,所以也可以不要

```
Offset      0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F

00000000   4D 5A CC CC 50 45 00 00  4C 01 01 00 75 73 65 72   MZ烫PE  L   user
00000010   33 32 2E 64 6C 6C 00 CC  80 00 0F 01 0B 01 4D 65   32.dll 虁     Me
00000020   73 73 61 67 65 42 6F 78  41 00 CC CC 30 00 00 00   ssageBoxA 烫0   
00000030   6A 00 EB 30 CC CC CC CC  00 00 40 00 04 00 00 00   j ?烫烫  @     
00000040   04 00 00 00 CC CC CC CC  CC CC CC CC 04 00 CC CC       烫烫烫烫  烫
00000050   00 00 00 00 00 10 00 00  C4 00 00 00 CC CC CC CC           ?  烫烫
00000060   02 00 00 00 68 0C 00 40  00 68 1E 00 40 00 6A 00       h  @ h  @ j 
00000070   FF 15 B8 00 40 00 C3 CC  04 00 00 00 00 00 00 00    ?@ 锰        
00000080   00 00 00 00 90 00 00 00  CC CC CC CC 00 00 00 00       ?  烫烫    
00000090   00 00 00 00 00 00 00 00  00 00 00 00 0C 00 00 00                   
000000A0   B8 00 00 00 C4 00 00 00  00 00 00 00 C4 00 00 00   ?  ?      ?  
000000B0   00 00 00 00 00 00 00 00  1C 
```

注意上面的可执行程序在 win10 无法运行,因为win10检查比较严格

## 二、本节作业

规则：

 \1. 小于185字节

 \2. PE头不能放在偏移为4的位置

 \3. 不能写死MessageBox地址，必须要有导入表

技巧:   通过修改选项头大小来控制节表位置,让他与数据表重合, 弹窗内容可以用PE .

PE.7z(1 KB)[](./pe.7z)

```
Offset      0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F

00000000   4D 5A 50 00 12 00 00 00  00 00 00 00 50 45 00 00   MZP         PE  
00000010   4C 01 01 00 4D 65 73 73  61 67 65 42 6F 78 41 00   L   MessageBoxA 
00000020   40 00 8E 81 0B 01 68 0C  00 40 00 6A 00 FF 15 04   @ ?  h  @ j   
00000030   00 40 00 C3 38 00 00 00  6A 00 EB 28 0C 00 00 00    @ ?   j ?    
00000040   00 00 40 00 04 00 00 00  04 00 00 00 75 73 65 72     @         user
00000050   33 32 00 00 04 00 00 00  00 00 00 00 00 10 00 00   32              
00000060   90 00 00 00 6A 00 EB BE  02 00 00 00 90 00 00 00       j 刖        
00000070   00 00 00 00 90 00 00 00  00 00 00 00 90 00 00 00                   
00000080   02 00 00 00 4C 00 00 00  04 00 00 00 78                L       x
```

